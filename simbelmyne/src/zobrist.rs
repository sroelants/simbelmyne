use std::ops::BitXorAssign;

use chess::board::Board;
use chess::movegen::castling::{CastlingRights, CastleType};
use chess::piece::Piece;
use chess::square::Square;


trait Zobrist {
    fn hash(&self) -> ZHash;
}

impl Zobrist for Board {
    fn hash(&self) -> ZHash {
        let mut hash = ZHash(0);

        // Toggle all the pieces
        for (idx, piece) in self.piece_list.into_iter().enumerate() {
            if let Some(piece) = piece {
                let square: Square = idx.into();
                hash.toggle_piece(piece, square);
            }
        }

        // Toggle the castling rights
        hash.toggle_castling(self.castling_rights);

        // Toggle EP square, if any
        if let Some(ep_sq) = self.en_passant {
            hash.toggle_ep(ep_sq);
        }

        // If black to move, add in the side key
        if self.current.is_black() {
            hash.toggle_side();
        }

        hash
    }
}

#[derive(Debug, Copy, Clone, PartialEq, Eq)]
pub struct ZHash(u64);

impl ZHash {
    pub const NULL: ZHash = ZHash(0);

    pub fn toggle_piece(&mut self, piece: Piece, square: Square) {
        *self ^= ZHash(PIECE_KEYS[piece as usize][square as usize]);
    }

    pub fn toggle_castling(&mut self, crights: CastlingRights) {
        *self ^= crights.hash();
    }

    pub fn toggle_ep(&mut self, ep_sq: Square) {
        *self ^= ep_sq.hash()
    }

    pub fn toggle_side(&mut self) {
        *self ^= ZHash(SIDE_KEY);
    }
}

impl Default for ZHash {
    fn default() -> Self {
        Self::NULL
    }
}

impl BitXorAssign for ZHash {
    fn bitxor_assign(&mut self, rhs: Self) {
        *self = ZHash(self.0 ^ rhs.0);
    }
}

impl Zobrist for CastlingRights {
    fn hash(&self) -> ZHash {
        let mut hash = ZHash(0);

        CastleType::get_all()
            .into_iter()
            .filter(|&ctype| self.is_available(ctype))
            .for_each(|ctype| hash ^= ctype.hash());

        hash
    }
}

impl Zobrist for CastleType {
    fn hash(&self) -> ZHash {
        ZHash(CASTLING_KEYS[*self as usize])
    }
}

impl Zobrist for Square {
    fn hash(&self) -> ZHash {
        ZHash(EP_KEYS[*self as usize])
    }
}

impl From<Board> for ZHash {
    fn from(value: Board) -> Self {
        value.hash()
    }
}

// ZKeys are Lookup keys derived from a Zobrist hash. 
//
// Their length depends on the size of the lookup table we wish to use, hence 
// we parametrize the type by a `const SIZE`.
//
// For example, if we decide on a Transposition table (TT) with 2^16 entries,
// we'll wrap the Zobrist hashes to fall in the range [0..2^16), yielding a
// ZKey<2^16>
#[derive(Debug, Copy, Clone, PartialEq, Eq)]
pub struct ZKey<const SIZE: usize>(pub usize); 

impl<const SIZE: usize> From<ZHash> for ZKey<SIZE> {
    fn from(value: ZHash) -> Self {
        ZKey(value.0 as usize % SIZE)
    }
}

////////////////////////////////////////////////////////////////////////////////
///
/// Constants
///
////////////////////////////////////////////////////////////////////////////////


const PIECE_KEYS: [[u64; Square::COUNT]; Piece::COUNT] = [
    [
        14959294065898493181,
        12021936500391551120,
        12354326297343548036,
        2568955646850906355,
        9211377413766735803,
        837503693812669346,
        15781064141342930256,
        15395131341638094445,
        16057872666224099539,
        1435218611613492882,
        213676722988859307,
        11735923393721204064,
        8390654354292249656,
        4455299767094433309,
        2377100351968707736,
        18425800783299200827,
        1657013359001514092,
        10216857805836186412,
        13308741547526543722,
        5655110101877694196,
        9608372859466917080,
        3796515343909607175,
        788155298482741066,
        191426241266939159,
        11153916265308009526,
        379397577702092521,
        7536596679441609264,
        15797442900286806341,
        4957873608356303817,
        16520603166533501216,
        16435296755284079762,
        2635716750345802448,
        2318348867220922620,
        8033806069431767473,
        4442310597826120207,
        943631980104790206,
        11360826044951702321,
        11659592365021130202,
        9795426849058311394,
        15237698803193185073,
        7179890787134086559,
        12390620463523063776,
        12806477998468451338,
        4101703988430942104,
        13453583284495398677,
        12144532973837823982,
        16963216230876748097,
        2764759138697231917,
        14274379974840187822,
        195618920898006412,
        12909972509491701301,
        10717673337701072602,
        7965833318076830078,
        1042809731752126796,
        10524528464671630471,
        1394205505548402169,
        13369291563729360944,
        6560759248186986745,
        8152798050263128272,
        9985394389317820738,
        11155597094447352284,
        14238644410413212166,
        6611275675260092809,
        9338858880645597876,
    ],
    [
        12642396972652971290,
        6037150929616306331,
        16694119474126808874,
        17766130998747617148,
        5013005385202007914,
        6674884304937387630,
        2543629348142170677,
        12295853281451415896,
        6285580604040031121,
        7601139102297599565,
        4274649556446502512,
        118777579758436848,
        6583511462047306617,
        9536375063329790492,
        3830210916091037230,
        10757487707351212530,
        13300143483741968693,
        14194670469300757562,
        7914746911966656631,
        15625844308273571494,
        13479763499304414588,
        3154710472942407127,
        483263292536115163,
        6669225049196140452,
        17234204404639191254,
        4775904590843676019,
        4381039024949979870,
        4897897389807398741,
        11511277754990400088,
        3877358998371065024,
        9122132845329889775,
        7966510554571633692,
        16855880377291039949,
        16647980344727936553,
        16120120388933330233,
        16751736618086434166,
        12904334521179001222,
        4759417125091558269,
        15590392247283098850,
        960969617250908712,
        16646546896402328787,
        5600243396594253235,
        11932641585303468611,
        11642892577768509115,
        17799988533018079063,
        9837300505415531904,
        8083745671397633904,
        7944774857255371483,
        5050491472440704264,
        2836620404818318617,
        16171262320539945243,
        11320927386847733212,
        1332863020071247690,
        2313421948028508363,
        16860284077900520889,
        5724652618225620451,
        5834285661186232404,
        10626037328306455466,
        755565866241338115,
        5101003955818310523,
        9060981757872213731,
        5161191237093861199,
        9605469248589628680,
        14329218194417716184,
    ],
    [
        7921641920047447732,
        14796950821588902948,
        13957924561228018131,
        14249737935518676581,
        12968298989197710413,
        12835169143984058485,
        5065730648093986703,
        7517569461675026931,
        2548643458948833544,
        17933760568881925433,
        11273899699261258084,
        4188284515502574728,
        12832245748099679085,
        316819815127549399,
        7377935365434287331,
        12644605342207196515,
        15510160735361976247,
        769176314488730051,
        3417471915550962365,
        13512465559354610723,
        15439851349297442016,
        699127228544435686,
        4333270407576284621,
        17154244551378017585,
        8520732626528025124,
        18316573488665596578,
        7816185693925860197,
        3672532343044435181,
        5021782813026335398,
        17257366669304244061,
        9593138049405374529,
        9772956066386360808,
        5037055598623240527,
        4049489416846555075,
        13047275247396927327,
        10991874027528983509,
        11651653546436347819,
        7661418374769827793,
        13895497561751411774,
        14277591070395286586,
        5608279802193071019,
        6110840383293069121,
        6528581052469799385,
        14361491104594986846,
        313079193020518751,
        10297410936190490318,
        7557846144712945339,
        1932995064606547920,
        8686488816110488007,
        7253832891951790848,
        7622862875533204775,
        10484388444230296390,
        16911495361385634943,
        6715813096103411208,
        4442871979763825798,
        8482887041060902842,
        8023646655741619490,
        17972165575004620864,
        6658632813122227714,
        1036996853460457184,
        6519680217321051373,
        17226652711916312427,
        6936282823467585427,
        15354799124821190776,
    ],
    [
        749000329726699217,
        6263173546101245507,
        18055050406541251031,
        14644111444947418319,
        10480006958706431302,
        12918999317402759989,
        11990921979475671980,
        9209351351259605455,
        16272238032293801233,
        2286142547263912444,
        8403757179029566987,
        108560271079422232,
        10021895399557969754,
        10599873101165777431,
        10004508000821696630,
        12937815014885807820,
        888013771154835741,
        9442654590047300744,
        9123748375613722856,
        15013233311086155512,
        10590152860705580184,
        3432659586478463485,
        4563898958643329189,
        592792475933064643,
        6398240874117977964,
        1333465177636524328,
        5292102617766638367,
        13050022662873747841,
        4059674581884421332,
        16216260050153195396,
        13814355188802562552,
        13377603773626573162,
        10443329849755482018,
        3481849423948091585,
        251230823828999877,
        16378814226943764277,
        4382033539689607199,
        18278730402990211219,
        18113701216954842799,
        18247561613569293750,
        10564120945356277345,
        10175620954432648895,
        7731295766460636967,
        5386725970435134784,
        8044235070063475923,
        11755210579820755258,
        9590903572229829984,
        1254226283438381310,
        7457150474685846582,
        10101132916118849012,
        4209552345456283657,
        14658953433986045939,
        2216176400656550283,
        10281305679723292514,
        16487374197775561614,
        11283359846041598450,
        182959174771316284,
        5961546776740752697,
        9208510074470682445,
        13314769017498680245,
        11140047858190374785,
        1799117891214582907,
        4123586346570630990,
        10486701768870215028,
    ],
    [
        4154539637517299713,
        14773673055722869453,
        8357460539941041663,
        16231324701945201664,
        15051180630728439941,
        5832337324232172863,
        16406069903296823479,
        5834232970698309368,
        3745679543777171766,
        2205911270641090593,
        11923027394432007994,
        7550399858286742090,
        4859193175067043824,
        15020125444899562242,
        14783768170495384670,
        9765213473557065929,
        5576853852114640687,
        18205184910199076854,
        7734801330535936741,
        12520945487878011174,
        5804569438115522625,
        1539060893951388450,
        16802618884756224748,
        10705398812134290098,
        1991050796592403285,
        11345014494060100825,
        14058594942381097549,
        6041526973292526931,
        13205847304173980793,
        8062532388224183649,
        13952481716653857791,
        12555008117691210004,
        15205202171161579880,
        4366684189262795866,
        10861554630050047094,
        10830773292640725984,
        13263270353633791207,
        6515733674022166694,
        6750481093783035173,
        12883109456801080277,
        17879068582323366072,
        14128328478150591462,
        11966440581267245914,
        3639015741088961570,
        800231324959373872,
        15028353889221676192,
        12809517973867151853,
        7583996158598271640,
        2138066636539234041,
        7560284613649541653,
        6266215491109845763,
        7381797581537208911,
        8994964584718394681,
        12467189194162259789,
        5457812338036588365,
        112140988749776043,
        14663989611555384844,
        13048718065549960038,
        15193293346675900989,
        11609103845819631382,
        17014176067619247994,
        4663218104746462570,
        169547985078285396,
        3192645460422922873,
    ],
    [
        16110052709193878024,
        12952069662250302815,
        17943317665468589152,
        6476190286404808825,
        13468762824032341997,
        15229620077559940764,
        2686841064171628382,
        2976856219501803277,
        3059778164064934808,
        13158667137912952530,
        8075295723418377854,
        9345527694752435940,
        4133924456316769756,
        15568911674816641711,
        14821655294028785176,
        5739565748525629752,
        3723382307853578090,
        9298665477442762524,
        729224129546070901,
        2397617785261234739,
        2644706804894015926,
        4166357927354241880,
        7843042023479168928,
        16798324773424198727,
        11537994205845950680,
        343750052097083261,
        9936577091598204696,
        14681346710940651129,
        8611961938777663955,
        13192054192662573853,
        17008251096668731921,
        15153357697264095269,
        7241822799048543556,
        5106007326994924666,
        6459445212534580834,
        8053357171787111809,
        262239736052463988,
        12473866920303582648,
        5029859478823290451,
        8290788776226027058,
        7005364777150209954,
        14343860692812383417,
        10841620655622196697,
        12176940047288308667,
        13050723322266495851,
        10004733014731702310,
        13643210993018980658,
        12644402298150025525,
        5819768714780238160,
        5105125568517890993,
        17688446344761071438,
        11705198382250276246,
        14365239536090411152,
        18180150809651884265,
        15401179156294871566,
        16669324439113331880,
        9913521013774486254,
        1638741356204888379,
        6954464718197981483,
        17900812780439933722,
        12752991431253399038,
        7326429031600585633,
        13613149333477209018,
        2984394458698963541,
    ],
    [
        17234463714925718116,
        4294233118847769260,
        7613929663135454595,
        13913114756986742666,
        13095476234122721463,
        1069382810141681087,
        16184874189778221412,
        16620752530245939513,
        15480209496505863301,
        4655816049395868055,
        6515930837621814568,
        7228387068742417950,
        1451803954656356564,
        12684088890573612066,
        17247318098414657087,
        15286208955059639142,
        16738021117039678103,
        402921621570776175,
        4431197238653417349,
        14909295074899674227,
        13200413908664191973,
        9775830798677087809,
        6325284300511334253,
        14810313998099518661,
        17140807670515060287,
        10372289381399684204,
        5367856069901325123,
        11516989330034173687,
        13556677709393086079,
        10472532699047917023,
        10283677595500583060,
        8470202480372997375,
        18402123121584570365,
        18374206191431892480,
        18223720398351164423,
        389963336103498723,
        15220591571005072345,
        12929862463302135311,
        7391319943049059365,
        16488874504467131388,
        16801443290738701002,
        8412580746966973547,
        5503565428914135062,
        18409297498826247342,
        3054096599507888993,
        12587101893528481323,
        15133123380106812668,
        13723022904710815150,
        14223061437596177962,
        16860059876595518323,
        14046530364136676492,
        13173441910560432660,
        10109096287436234537,
        12605764183566538250,
        16516173816598065419,
        6991358527575518592,
        5109250124757968106,
        5552282964470615066,
        8233528710195825339,
        9982562184637412651,
        16832867936649484695,
        15278197421537943459,
        11203297919082737052,
        6244464998820078193,
    ],
    [
        2349905241004725135,
        14186002623429563998,
        3875945471598271140,
        11356777016809327569,
        9477009187400710439,
        12746531489423837077,
        17170494471328669555,
        9214470204890555653,
        15337336201624563750,
        13991408970910420889,
        14229701860715902291,
        2383434084980784024,
        1379718883721726749,
        2894168094225328432,
        13813996629299876047,
        7487958407810673789,
        5139464118663254671,
        755388488545429909,
        13238927951885171699,
        13574451056768557770,
        16581359131454697781,
        11527632100276184482,
        5481596165068809843,
        4087344883845788330,
        18264812648293494492,
        17078533440932158703,
        67686604143447823,
        871712358787681300,
        11491271296798317114,
        1062946574141694342,
        12402174862619490227,
        6695960878199789255,
        5999516024667687581,
        12647116752171806305,
        11673884999940187439,
        6755494641455989537,
        1906793173260346468,
        8262445518037322647,
        11791936986119064557,
        13941788346899594010,
        12133659388673287859,
        14049350787888010894,
        15524976975805122090,
        7555599800330872060,
        5413293263663560686,
        18094435089363773637,
        10527798434944318725,
        14180221140634216797,
        5858394256835335146,
        9588461238496185890,
        14152205599494879102,
        9970811684003966058,
        888745752426302673,
        8370698711513528884,
        1857865701904503370,
        17237406382597084053,
        1052059868595654074,
        5162143852935475494,
        6808441530980630466,
        7825546558326238640,
        239562708684644832,
        15890862728615484035,
        10877274154707386610,
        7635049013130943433,
    ],
    [
        14326964011076970808,
        12496352055516823291,
        14395228882626013616,
        16830298276458994705,
        8587517624744474106,
        11875539962633471313,
        7539365677935955862,
        16685132937516974733,
        10741299824071649544,
        8275882103853780649,
        7005478990069672189,
        4494330361822166799,
        6471895264032491818,
        14590740460261075615,
        1315142902120435867,
        13442577032488548921,
        17693916663144192347,
        439262450190976077,
        11891652042546046433,
        16403436920825576520,
        9104665369907980883,
        14685804482240028900,
        12689732835077539825,
        8091399736215236923,
        18294719079361408281,
        14228590051846935993,
        16383053611301511801,
        17271329515105317868,
        6434695768861170535,
        14230986820318707001,
        13031178952834205587,
        18260216224081050090,
        9609707844555205405,
        2629577617878732041,
        16723684611783743776,
        10397465472639102626,
        18115397878302973081,
        1624806883763191080,
        15202784283204784923,
        14073651098259911265,
        3137898383116779547,
        13927492806970030712,
        10713362610951227732,
        9964210486687598018,
        3301984876404235751,
        11013614242704994031,
        5553257601789869222,
        9090792487448240439,
        7195570155317160283,
        7369584468832167420,
        3603432554040052431,
        17679719064856545511,
        6386582329101958902,
        12375661410678994427,
        16340029661694020759,
        11478487613031345072,
        930873616245665586,
        16595795666037275039,
        17431239983781091496,
        1438559218378999827,
        5696880386968648775,
        5917184053399471479,
        5678347459062384426,
        14366847772234052373,
    ],
    [
        3789928278290060349,
        9047703832949896118,
        5198030913282810657,
        9514602154833604041,
        17085479576495901919,
        12383737686839323573,
        13714852713914085216,
        12793197907428156898,
        10010210833736450485,
        11197189690994021074,
        6751102332614034001,
        11859823941038784021,
        17868464180293368088,
        15790834090948799787,
        6774297653749974101,
        13393854661814998018,
        6903374460105102639,
        2012810773386291692,
        17324314424891555176,
        8820551002775075428,
        11914174397668544941,
        8523867382160860182,
        12997195044300055298,
        9129469735246839762,
        6451257147502386596,
        12974191477333344376,
        14611135381986515179,
        2062306639588205464,
        5328582602638830339,
        15569653256111659232,
        18373250629840503837,
        11430096376847292036,
        4451942261206971262,
        15937750702578888398,
        18420492409865139497,
        1114815611834463362,
        4420936718716357248,
        10362986250625109314,
        18397439122886571606,
        6594008535537744998,
        2285974284320973462,
        11563927324333123664,
        18006888115653551371,
        13392022387923023809,
        16409229221437537995,
        14426738341457098267,
        17071070633896736288,
        10229954259261585687,
        17076775404924554988,
        3545757481627212436,
        12270364687406391913,
        8827502370956184498,
        16601857158704771103,
        10378012908906164406,
        5519520599171843681,
        7034992727297311563,
        17846946991068949580,
        1432877024673245399,
        3274733219457540290,
        10955206705270575084,
        4303470433670323762,
        18358929416149878613,
        14385032917382730880,
        14180242864892319934,
    ],
    [
        13621406129003622937,
        7032103676151534220,
        8059295384575440013,
        5704280519817624478,
        5776941486915673544,
        13705458487786661041,
        1200021741652773281,
        11118560027744426924,
        11458644624063222214,
        1668054714531888274,
        9469789986952885376,
        17758305400033241259,
        6057961401106539874,
        5734368861855865176,
        8500741581952300694,
        8593817162498299327,
        2703340049296208348,
        15358080812803154031,
        7640681215525508185,
        7227690097502545468,
        2684282221541030843,
        1263384708423861492,
        10225299573064302526,
        9750483321904896214,
        14726735111938510353,
        5214060364118120859,
        182777541085608611,
        10494910356498757019,
        1014720668955909834,
        17452479466626220572,
        13548388789834429865,
        1304618922120168722,
        6797806773429172700,
        18320614415837844722,
        5785778687593241204,
        8135634169884825627,
        6651064797017025940,
        17806549589572236416,
        794833906527830846,
        5339469303044156887,
        12848371100332367851,
        5715550370239543123,
        5576948960930347577,
        1603115414553290670,
        1526773159535434272,
        6842028816031819053,
        1092709021113422620,
        7808084184835584551,
        8049422099293987654,
        6815564585798689671,
        7717262954233744079,
        17277594559484106628,
        17139541111362807786,
        10972434319752871831,
        12553263639927441384,
        16508280333249289707,
        14162393031659343029,
        4497482167937745863,
        2029102495652061445,
        74679336997803983,
        9984591302642025155,
        11773003605865760696,
        5468582254625966,
        8023073824527018236,
    ],
    [
        11807167460942162233,
        6975307258271396783,
        3070711752905712229,
        9719742629920571301,
        1915059720384156249,
        16084502950633545091,
        16490156845326183140,
        17921450325547280824,
        2861906183908705026,
        8090755289628317172,
        17236126528034480645,
        2533120170425127205,
        3399932656768323287,
        11260289315405847864,
        13330646943551595588,
        6321346857746785686,
        13940476401318821507,
        17195289480934607077,
        12790888073332039841,
        2245874097646127307,
        11508851448499339379,
        9523896725380275360,
        7800167419548524666,
        17820573880755968219,
        10241492592168444336,
        15776986743068082352,
        9720207460620556456,
        8917241115700355095,
        10027664258436482398,
        9673256701484843364,
        3592251560858585688,
        5789639372108979472,
        2077910855911208417,
        13548124344253100279,
        8628588771691281085,
        8012773467814590953,
        4393642205611461707,
        7396908155944304703,
        13140280582360103434,
        8788557845548295973,
        16480253797287533541,
        5310498742501085336,
        17664175871324199686,
        11210483394629844621,
        14364667371774472125,
        10635805543893445511,
        1154531905575474279,
        9374520884858234383,
        147355318373178256,
        9302097054950004404,
        8866223319343173600,
        9714888971006712971,
        10487862724963259139,
        6259360374396186837,
        4878514679351203915,
        2973779136663511117,
        15644264668503962220,
        17012741342127398317,
        13620631091656432949,
        17671287119211936254,
        11825985686212870878,
        371268325250498868,
        467641706729484703,
        17324619645017413135,
    ],
];

const EP_KEYS: [u64; Square::COUNT] = [
    1857398152717705386,
    17641826588492959511,
    1806847443134180088,
    15301737390174500808,
    544525853979565256,
    213297498120582128,
    17645278013721602040,
    15344571986893697305,
    8626778735168779642,
    8096899286807858915,
    12663809889092094749,
    12880900025523555639,
    15106936368359139504,
    9923330814089098224,
    2977026591315444102,
    9466650677289095733,
    12789153788308781890,
    2210747732133216845,
    11142329947284937241,
    1349647447918135541,
    14884967544834942558,
    9599177884151908217,
    5509055054525398352,
    15750245393524133647,
    16904699915167078733,
    3715652144802887180,
    9076264242793474815,
    487500785415785922,
    17164575107762623437,
    18398510982968896648,
    14426299723013867681,
    17570902398248583802,
    15578419192485320339,
    16060455720072291947,
    17120562408098291800,
    3122624596801323299,
    1783888621055198299,
    3275311720320017619,
    4263839492307988829,
    17680587951994407347,
    10037397607219832703,
    16906619612501227082,
    3975819957400752431,
    4160598171304309943,
    9349634572648564091,
    5281721670828593196,
    3879175806451085008,
    10557228654728007815,
    3633229847999101312,
    5223051299274023398,
    13120447069702223567,
    14629158028764726645,
    4585559306705061968,
    1328616297288613333,
    8126971987822378634,
    1095164581495755126,
    9348994866941278914,
    13646117324074068058,
    11675515098407720889,
    11355208568419397615,
    13663750231113810566,
    3736434052215199290,
    15798549790127970019,
    17685610063530010872,
];

const CASTLING_KEYS: [u64; 4] = [
    13531567583369405739,
    17629992365325656693,
    10190733566263144126,
    4696804457198849606,
];

const SIDE_KEY: u64 = 7730473513326325857;
